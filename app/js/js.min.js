class mainObjectClass {
    constructor() {
        //интервал запросов
        this.requestInterval = 10;

        //время отправки сообщения (переаодим в сек)
        this.messageTime = 23 * 60;

        //время до просрочки (переводим в сек)
        this.expirationTime = 30 * 60;

        //пустой массив под заказы
        this.orders = [];
    }
}
class orderClass {
    constructor(orderNumber) {
        this.unixTime = parseInt(new Date().getTime() / 1000);
        this.date = parseInt(new Date().getDate());
        this.expired = false;
        this.messageSent = false;
        this.complete = false;
        this.completeTime = 0;
        this.inQueue = false;
        this.preparing = false;
        this.orderNumber = orderNumber;
        this.needMessage = false;
        this.remade = false;
    }

    setExpired() {
        this.expired = true;
    }

    setMessageSent() {
        this.messageSent = true;
        this.needMessage = false;
    }

    setNeedMessage(){
        this.needMessage = true;
    }

    setTime(time) {
        this.completeTime = time - this.unixTime;
    }

    setQueue() {
        this.inQueue = true;
        this.preparing = false;
    }

    setPreparing() {
        this.preparing = true;
        this.inQueue = false;
    }

    setComplete() {
        this.complete = true;
        this.preparing = false;
        this.inQueue = false;
    }

    setRemade(){
        this.Complete = false;
        this.Remade = true;
    }

}

function getMainObject() {
    return JSON.parse(localStorage.getItem('mainObject'));
}

function isMainObjectExists() {
    return localStorage.getItem('mainObject') !== null;
}

function setMainObject(mainObject) {
    localStorage.setItem('mainObject', JSON.stringify(mainObject));
}

function ismainObjectContainsOrder(mainObject, orderNumber) {
    for (let i = 0; i < mainObject.orders.length; i++) {
        if (mainObject.orders[i].orderNumber === orderNumber) {
            return true;
        }
    }
    return false;
}

function getSameOrder(newContentObject, orderNumber) {
    for (let i = 0; i < newContentObject.orders.length; i++) {
        if (newContentObject.orders[i].orderNumber === orderNumber) {
            return newContentObject.orders[i].orderNumber;
        }
    }
    return false;
}

function isOrderRemade(mainObject, orderNumber) {
    for (let i = 0; i < mainObject.orders.length; i++) {
        if (mainObject.orders[i].orderNumber === orderNumber && mainObject.orders[i].complete === true) {
            return true;
        }
    }
    return false;
}

function secondsTimeToNormal(seconds) {
    let minutes = Math.floor(seconds / 60) + '';
    let secs = seconds % 60 + '';
    if (secs.length < 2) {
        secs = '0' + secs;
    }
    const result = minutes + ':' + secs;
    return result;
}
document.addEventListener("DOMContentLoaded", () => {
    function setContentHeight() {
        const header = document.querySelector('.header');
        const wrapper = document.querySelector('.wrapper');
        const footer = document.querySelector('.footer');
        const setHeightContainer = document.querySelector('.set-height');
        const neededHeight = wrapper.offsetHeight - header.offsetHeight - footer.offsetHeight;

        if (setHeightContainer.offsetHeight < neededHeight) {
            setHeightContainer.style.height = neededHeight + 'px';
        }
    }

    setContentHeight();
    window.addEventListener('resize', setContentHeight);
})



const model = {


    callExternalContent() {
        return new Promise((resolve, reject) => {
            const x = new XMLHttpRequest();

            //ajax запрос через прокси cors-anywhere
            x.open('GET', 'https://cors-anywhere.herokuapp.com/https://akson.ru/personal/order/table1/?STORE_ID=11');
            //x.open('GET', 'pz4.html');

            //x.timeout = 5000;
            x.send();
            x.onload = () => {
                if (x.status != 200) {
                    reject(x.statusText)
                } else {
                    resolve(x.responseText || '');
                }
            };
        })
    },
    //
    getContent(externalContent) {
        //вытаскиваем таблицу из исходного кода
        const cutExternalContent = externalContent.substr(3196, externalContent.length - 3370);
        //console.log(cutExternalContent);
        const hiddenTable = document.querySelector('.hidden-table');
        hiddenTable.innerHTML = cutExternalContent;
        //вытаскиваем строки
        const rows = document.getElementsByTagName('tr');
        //переменная для строк фильтрованной таблицы
        let filteredRows = [];

        //удаляем строки заголовков таблиц, удаляем отмененные заказы, формируем одну таблицу из двух
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].innerHTML.length !== 377) {
                if (rows[i].children[3].innerHTML.length > 100) {
                    rows[i].parentNode.removeChild(rows[i]);
                } else {
                    filteredRows.push(rows[i]);
                }
            }
        }
        //удаляем четвертую ячейку
        for (let i = 0; i < filteredRows.length; i++) {
            filteredRows[i].removeChild(filteredRows[i].children[3]);
        }

        const newContentObject = new mainObjectClass();
        filteredRows.forEach((item) => {
            const orderNumber = parseInt(item.children[0].children[0].children[0].innerHTML);
            const order = new orderClass(orderNumber);
            //console.log(item.children[1].children[0].innerHTML.length);
            if (item.children[1].children[0].innerHTML.length > 30) {
                order.setQueue();
            } else if (item.children[2].children[0].innerHTML.length > 30) {
                order.setPreparing();
            }
            newContentObject.orders.push(order);
        })

        //удаляем таблицу
        hiddenTable.innerHTML = '';

        if (!isMainObjectExists()) {
            setMainObject(newContentObject);
            this.getContent(externalContent);
        } else {
            const notFormattedmainObject = getMainObject();
            const mainObject = new mainObjectClass();

            mainObject.requestInterval = notFormattedmainObject.requestInterval;
            mainObject.messageTime = notFormattedmainObject.messageTime;
            mainObject.expirationTime = notFormattedmainObject.expirationTime;

            notFormattedmainObject.orders.forEach((item) => {
                let currentOrder = new orderClass(item.orderNumber);
                currentOrder.expired = item.expired;
                currentOrder.messageSent = item.messageSent;
                currentOrder.complete = item.complete;
                currentOrder.completeTime = item.completeTime;
                currentOrder.inQueue = item.inQueue;
                currentOrder.preparing = item.preparing;
                currentOrder.remade = item.remade;
                currentOrder.unixTime = item.unixTime;
                currentOrder.date = item.date;
                currentOrder.needMessage = item.needMessage;
                mainObject.orders.push(currentOrder);
            })


            // Добавляем новые заказы
            newContentObject.orders.forEach((item, i) => {
                if (!ismainObjectContainsOrder(mainObject, item.orderNumber)) {
                    mainObject.orders.push(newContentObject.orders[i]);
                }
            })
            //если старого заказа нет в списке заказов нового объекта, помечаем старый подтвержденным
            mainObject.orders.forEach((item) => {
                if (!getSameOrder(newContentObject, item.orderNumber)) {
                    item.setComplete();
                }
            })
            //получаем перевыгруженные заказы
            newContentObject.orders.forEach((item) => {
                if (isOrderRemade(mainObject, item.orderNumber)) {
                    for (let i = 0; i < mainObject.orders.length; i++) {
                        if (mainObject.orders[i].orderNumber === item.orderNumber) {
                            mainObject.orders[i].remade = true;
                            mainObject.orders[i].expired = item.expired;
                            mainObject.orders[i].messageSent = false;
                            mainObject.orders[i].unixTime = parseInt(new Date().getTime() / 1000);
                            mainObject.orders[i].complete = false;
                            mainObject.orders[i].completeTime = 0;
                            mainObject.orders[i].inQueue = item.inQueue;
                            mainObject.orders[i].preparing = item.preparing;
                            mainObject.orders[i].date = item.date;
                            mainObject.orders[i].needMessage = item.needMessage;
                        }
                    }
                }
            })

            //задаем время наборки
            mainObject.orders.forEach((item) => {
                if (item.complete === false) {
                    item.setTime(parseInt(new Date().getTime() / 1000));
                }
            })

            //проверяем на просрочку

            mainObject.orders.forEach((item) => {
                if (item.completeTime > mainObject.expirationTime) {
                    item.setExpired();
                }
            })

            //удаляем заказы возрастом более 10 дней
            for (let i = mainObject.orders.length - 1; i >= 0; i--) {
                if (parseInt(new Date().getTime() / 1000) - mainObject.orders[i].unixTime > 864000) {
                    mainObject.orders.splice(i, 1);
                }
            }

            setMainObject(mainObject);
        }
    },

    setWarning() {
        const mainObject = getMainObject();
        mainObject.orders.forEach((item) => {
            if (parseInt(new Date().getTime() / 1000) - item.unixTime > mainObject.messageTime && !item.complete && !item.messageSent) {
                item.needMessage = true;
            }
        })
        setMainObject(mainObject);
    }


}
const view = {
    drawTable() {
        const mainObject = getMainObject();
        const newTable = document.querySelector('.new-table');
        newTable.insertAdjacentHTML('beforeend', '' +
            '                 <thead>' +
            '                    <tr class="new-table__header">\n' +
            '                        <th class="new-table__header-cell">№</th>\n' +
            '                        <th class="new-table__header-cell">Номер заказа</th>\n' +
            '                        <th class="new-table__header-cell">В очереди</th>\n' +
            '                        <th class="new-table__header-cell">В наборе</th>\n' +
            '                        <th class="new-table__header-cell">Завершен</th>\n' +
            '                        <th class="new-table__header-cell">Время</th>\n' +
            '                    </tr>' +
            '                 </thead>');

        let counter = 1;
        mainObject.orders.forEach((item) => {

            let inQueue = '';
            if (item.inQueue === true) {
                inQueue = 'X';
            }
            let preparing = '';
            if (item.preparing === true) {
                preparing = 'X';
            }
            let complete = '';
            if (item.complete === true) {
                complete = 'X';
            }
            let time = secondsTimeToNormal(item.completeTime);
            if (item.date === parseInt(new Date().getDate()) && item.remade && !item.messageSent) {
                newTable.insertAdjacentHTML('beforeend', `
                    <tbody>
                        <tr class="new-table__row new-table__order-remade">
                            <td class="new-table__cell">${counter}</td>
                            <td class="new-table__cell">${item.orderNumber}</td>
                            <td class="new-table__cell">${inQueue}</td>
                            <td class="new-table__cell">${preparing}</td>
                            <td class="new-table__cell">${complete}</td>
                            <td class="new-table__cell">${time}</td>
                        </tr>
                    </tbody>`
                )
            } else if (item.date === parseInt(new Date().getDate()) && !item.expired && !item.messageSent) {
                newTable.insertAdjacentHTML('beforeend', `
                    <tbody>
                        <tr class="new-table__row new-table__order-normal">
                            <td class="new-table__cell">${counter}</td>
                            <td class="new-table__cell">${item.orderNumber}</td>
                            <td class="new-table__cell">${inQueue}</td>
                            <td class="new-table__cell">${preparing}</td>
                            <td class="new-table__cell">${complete}</td>
                            <td class="new-table__cell">${time}</td>
                        </tr>
                    </tbody>`
                )
            } else if (item.date === parseInt(new Date().getDate()) && !item.expired && item.messageSent) {
                newTable.insertAdjacentHTML('beforeend', `
                    <tbody>
                        <tr class="new-table__row new-table__order-warning">
                            <td class="new-table__cell">${counter}</td>
                            <td class="new-table__cell">${item.orderNumber}</td>
                            <td class="new-table__cell">${inQueue}</td>
                            <td class="new-table__cell">${preparing}</td>
                            <td class="new-table__cell">${complete}</td>
                            <td class="new-table__cell">${time}</td>
                        </tr>
                    </tbody>`
                )
            } else if (item.date === parseInt(new Date().getDate()) && item.expired && item.messageSent) {
                newTable.insertAdjacentHTML('beforeend', `
                    <tbody>
                        <tr class="new-table__row new-table__order-expired">
                            <td class="new-table__cell">${counter}</td>
                            <td class="new-table__cell">${item.orderNumber}</td>
                            <td class="new-table__cell">${inQueue}</td>
                            <td class="new-table__cell">${preparing}</td>
                            <td class="new-table__cell">${complete}</td>
                            <td class="new-table__cell">${time}</td>
                        </tr>
                    </tbody>`
                )

            }
            counter++;
        })

    },

    sendMessage(message) {
        const x = new XMLHttpRequest();
        x.open('GET', 'https://api.telegram.org/bot1018757013:AAEHO9accUhscieT0ArRq9iwUeat6BmEzOM/sendMessage?chat_id=-1001471677614&text=' + message);
        x.send();


    },

    sendMessages() {
        const mainObject = getMainObject();
        mainObject.orders.forEach((item) => {
            if (item.needMessage === true) {
                this.sendMessage('Заказ ' + item.orderNumber + ' в наборе уже более ' + mainObject.messageTime / 60 + ' минут');
                //console.log('Заказ ' + item.orderNumber + ' в наборе уже более ' + mainObject.expirationTime / 60 + ' минут')
                item.messageSent = true;
                item.needMessage = false;
            }
        })
        setMainObject(mainObject);
    },

    setPlaceholders() {
        const mainObject = getMainObject();
        document.querySelector('.options__time-to-expire').placeholder = mainObject.expirationTime / 60;
        document.querySelector('.options__time-to-send-message').placeholder = mainObject.messageTime / 60;
        document.querySelector('.options__request-interval').placeholder = mainObject.requestInterval;
    }
}
const controller = {
    mainRoute(){
        let interval = 10;
        if (isMainObjectExists()) {
            const mainObject = getMainObject();
            interval = mainObject.requestInterval;
        }

        model.callExternalContent()
            .then((response) => {
                model.getContent(response);
                model.setWarning();
                view.sendMessages();
                view.drawTable();
                view.setPlaceholders();
                document.getElementById('interval').scrollIntoView();
            })

        window.setTimeout(() => {
            window.location.reload();
        }, interval * 1000);
    }
}
document.addEventListener("DOMContentLoaded", () => {
controller.mainRoute();
})

//устанавливаем интервал, время сообщения, время до просрочки
document.querySelector('.options__time-to-expire-button').addEventListener('click', (e) => {
    e.preventDefault();
    const expireTextArea = document.querySelector('.options__time-to-expire');
    if (expireTextArea.value) {
        const mainObject = getMainObject();
        mainObject.expirationTime = parseInt(expireTextArea.value) * 60;
        setMainObject(mainObject);
        expireTextArea.placeholder = expireTextArea.value;
        expireTextArea.value = '';
    } else {
        const messageBox = document.querySelector('.options__message-box-time-to-expire');
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 1000)
    }
})

document.querySelector('.options__time-to-send-message-button').addEventListener('click', (e) => {
    e.preventDefault();
    const messageTextArea = document.querySelector('.options__time-to-send-message');
    if (messageTextArea.value) {
        const mainObject = getMainObject();
        mainObject.messageTime = parseInt(messageTextArea.value) * 60;
        messageTextArea.placeholder = messageTextArea.value;
        messageTextArea.value = '';
        setMainObject(mainObject);
    } else {
        const messageBox = document.querySelector('.options__message-box-time-to-send-message');
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 1000)
    }
})

document.querySelector('.options__request-interval-button').addEventListener('click', (e) => {
    e.preventDefault();
    const requestTextArea = document.querySelector('.options__request-interval');
    if (requestTextArea.value && parseInt(requestTextArea.value) >= 10) {
        const mainObject = getMainObject();
        mainObject.requestInterval = parseInt(requestTextArea.value);
        requestTextArea.placeholder = requestTextArea.value;
        requestTextArea.value = '';
        setMainObject(mainObject);
    } else {
        const messageBox = document.querySelector('.options__message-box-request-interval');
        messageBox.style.display = 'block';
        requestTextArea.value = '';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 1000)
    }
})

document.querySelector('.reset').addEventListener('click', (e)=>{
    const msg = prompt('Действительно? Все данные удалятся! Для продолжения введите "УДАЛИТЬ!" большими буквами');
    if(msg ==='УДАЛИТЬ!'){
        localStorage.clear();
        window.location.reload();
    }
})
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk1haW5PYmplY3RDbGFzcy5qcyIsIm9yZGVyQ2xhc3MuanMiLCJmdW5jdGlvbnMuanMiLCJhZGp1c3RtZW50LmpzIiwiTW9kZWwuanMiLCJWaWV3LmpzIiwiQ29udHJvbGxlci5qcyIsIm1haW4uanMiLCJldmVudExpc3RlbmVycy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNkQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3REQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaktBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0SEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RCQTtBQUNBO0FBQ0E7QUFDQTtBQ0hBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJqcy5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBtYWluT2JqZWN0Q2xhc3Mge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAvL9C40L3RgtC10YDQstCw0Lsg0LfQsNC/0YDQvtGB0L7QslxuICAgICAgICB0aGlzLnJlcXVlc3RJbnRlcnZhbCA9IDEwO1xuXG4gICAgICAgIC8v0LLRgNC10LzRjyDQvtGC0L/RgNCw0LLQutC4INGB0L7QvtCx0YnQtdC90LjRjyAo0L/QtdGA0LXQsNC+0LTQuNC8INCyINGB0LXQuilcbiAgICAgICAgdGhpcy5tZXNzYWdlVGltZSA9IDIzICogNjA7XG5cbiAgICAgICAgLy/QstGA0LXQvNGPINC00L4g0L/RgNC+0YHRgNC+0YfQutC4ICjQv9C10YDQtdCy0L7QtNC40Lwg0LIg0YHQtdC6KVxuICAgICAgICB0aGlzLmV4cGlyYXRpb25UaW1lID0gMzAgKiA2MDtcblxuICAgICAgICAvL9C/0YPRgdGC0L7QuSDQvNCw0YHRgdC40LIg0L/QvtC0INC30LDQutCw0LfRi1xuICAgICAgICB0aGlzLm9yZGVycyA9IFtdO1xuICAgIH1cbn0iLCJjbGFzcyBvcmRlckNsYXNzIHtcbiAgICBjb25zdHJ1Y3RvcihvcmRlck51bWJlcikge1xuICAgICAgICB0aGlzLnVuaXhUaW1lID0gcGFyc2VJbnQobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKTtcbiAgICAgICAgdGhpcy5kYXRlID0gcGFyc2VJbnQobmV3IERhdGUoKS5nZXREYXRlKCkpO1xuICAgICAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5tZXNzYWdlU2VudCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNvbXBsZXRlID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY29tcGxldGVUaW1lID0gMDtcbiAgICAgICAgdGhpcy5pblF1ZXVlID0gZmFsc2U7XG4gICAgICAgIHRoaXMucHJlcGFyaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMub3JkZXJOdW1iZXIgPSBvcmRlck51bWJlcjtcbiAgICAgICAgdGhpcy5uZWVkTWVzc2FnZSA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlbWFkZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIHNldEV4cGlyZWQoKSB7XG4gICAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgc2V0TWVzc2FnZVNlbnQoKSB7XG4gICAgICAgIHRoaXMubWVzc2FnZVNlbnQgPSB0cnVlO1xuICAgICAgICB0aGlzLm5lZWRNZXNzYWdlID0gZmFsc2U7XG4gICAgfVxuXG4gICAgc2V0TmVlZE1lc3NhZ2UoKXtcbiAgICAgICAgdGhpcy5uZWVkTWVzc2FnZSA9IHRydWU7XG4gICAgfVxuXG4gICAgc2V0VGltZSh0aW1lKSB7XG4gICAgICAgIHRoaXMuY29tcGxldGVUaW1lID0gdGltZSAtIHRoaXMudW5peFRpbWU7XG4gICAgfVxuXG4gICAgc2V0UXVldWUoKSB7XG4gICAgICAgIHRoaXMuaW5RdWV1ZSA9IHRydWU7XG4gICAgICAgIHRoaXMucHJlcGFyaW5nID0gZmFsc2U7XG4gICAgfVxuXG4gICAgc2V0UHJlcGFyaW5nKCkge1xuICAgICAgICB0aGlzLnByZXBhcmluZyA9IHRydWU7XG4gICAgICAgIHRoaXMuaW5RdWV1ZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIHNldENvbXBsZXRlKCkge1xuICAgICAgICB0aGlzLmNvbXBsZXRlID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5wcmVwYXJpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pblF1ZXVlID0gZmFsc2U7XG4gICAgfVxuXG4gICAgc2V0UmVtYWRlKCl7XG4gICAgICAgIHRoaXMuQ29tcGxldGUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5SZW1hZGUgPSB0cnVlO1xuICAgIH1cblxufVxuIiwiZnVuY3Rpb24gZ2V0TWFpbk9iamVjdCgpIHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbWFpbk9iamVjdCcpKTtcbn1cblxuZnVuY3Rpb24gaXNNYWluT2JqZWN0RXhpc3RzKCkge1xuICAgIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbWFpbk9iamVjdCcpICE9PSBudWxsO1xufVxuXG5mdW5jdGlvbiBzZXRNYWluT2JqZWN0KG1haW5PYmplY3QpIHtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnbWFpbk9iamVjdCcsIEpTT04uc3RyaW5naWZ5KG1haW5PYmplY3QpKTtcbn1cblxuZnVuY3Rpb24gaXNtYWluT2JqZWN0Q29udGFpbnNPcmRlcihtYWluT2JqZWN0LCBvcmRlck51bWJlcikge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWFpbk9iamVjdC5vcmRlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKG1haW5PYmplY3Qub3JkZXJzW2ldLm9yZGVyTnVtYmVyID09PSBvcmRlck51bWJlcikge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBnZXRTYW1lT3JkZXIobmV3Q29udGVudE9iamVjdCwgb3JkZXJOdW1iZXIpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5ld0NvbnRlbnRPYmplY3Qub3JkZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChuZXdDb250ZW50T2JqZWN0Lm9yZGVyc1tpXS5vcmRlck51bWJlciA9PT0gb3JkZXJOdW1iZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXdDb250ZW50T2JqZWN0Lm9yZGVyc1tpXS5vcmRlck51bWJlcjtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGlzT3JkZXJSZW1hZGUobWFpbk9iamVjdCwgb3JkZXJOdW1iZXIpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1haW5PYmplY3Qub3JkZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChtYWluT2JqZWN0Lm9yZGVyc1tpXS5vcmRlck51bWJlciA9PT0gb3JkZXJOdW1iZXIgJiYgbWFpbk9iamVjdC5vcmRlcnNbaV0uY29tcGxldGUgPT09IHRydWUpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gc2Vjb25kc1RpbWVUb05vcm1hbChzZWNvbmRzKSB7XG4gICAgbGV0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHNlY29uZHMgLyA2MCkgKyAnJztcbiAgICBsZXQgc2VjcyA9IHNlY29uZHMgJSA2MCArICcnO1xuICAgIGlmIChzZWNzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgc2VjcyA9ICcwJyArIHNlY3M7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IG1pbnV0ZXMgKyAnOicgKyBzZWNzO1xuICAgIHJldHVybiByZXN1bHQ7XG59IiwiZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgKCkgPT4ge1xuICAgIGZ1bmN0aW9uIHNldENvbnRlbnRIZWlnaHQoKSB7XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5oZWFkZXInKTtcbiAgICAgICAgY29uc3Qgd3JhcHBlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy53cmFwcGVyJyk7XG4gICAgICAgIGNvbnN0IGZvb3RlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5mb290ZXInKTtcbiAgICAgICAgY29uc3Qgc2V0SGVpZ2h0Q29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNldC1oZWlnaHQnKTtcbiAgICAgICAgY29uc3QgbmVlZGVkSGVpZ2h0ID0gd3JhcHBlci5vZmZzZXRIZWlnaHQgLSBoZWFkZXIub2Zmc2V0SGVpZ2h0IC0gZm9vdGVyLm9mZnNldEhlaWdodDtcblxuICAgICAgICBpZiAoc2V0SGVpZ2h0Q29udGFpbmVyLm9mZnNldEhlaWdodCA8IG5lZWRlZEhlaWdodCkge1xuICAgICAgICAgICAgc2V0SGVpZ2h0Q29udGFpbmVyLnN0eWxlLmhlaWdodCA9IG5lZWRlZEhlaWdodCArICdweCc7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXRDb250ZW50SGVpZ2h0KCk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHNldENvbnRlbnRIZWlnaHQpO1xufSlcblxuXG4iLCJjb25zdCBtb2RlbCA9IHtcblxuXG4gICAgY2FsbEV4dGVybmFsQ29udGVudCgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHggPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcblxuICAgICAgICAgICAgLy9hamF4INC30LDQv9GA0L7RgSDRh9C10YDQtdC3INC/0YDQvtC60YHQuCBjb3JzLWFueXdoZXJlXG4gICAgICAgICAgICB4Lm9wZW4oJ0dFVCcsICdodHRwczovL2NvcnMtYW55d2hlcmUuaGVyb2t1YXBwLmNvbS9odHRwczovL2Frc29uLnJ1L3BlcnNvbmFsL29yZGVyL3RhYmxlMS8/U1RPUkVfSUQ9MTEnKTtcbiAgICAgICAgICAgIC8veC5vcGVuKCdHRVQnLCAncHo0Lmh0bWwnKTtcblxuICAgICAgICAgICAgLy94LnRpbWVvdXQgPSA1MDAwO1xuICAgICAgICAgICAgeC5zZW5kKCk7XG4gICAgICAgICAgICB4Lm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoeC5zdGF0dXMgIT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCh4LnN0YXR1c1RleHQpXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh4LnJlc3BvbnNlVGV4dCB8fCAnJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIC8vXG4gICAgZ2V0Q29udGVudChleHRlcm5hbENvbnRlbnQpIHtcbiAgICAgICAgLy/QstGL0YLQsNGB0LrQuNCy0LDQtdC8INGC0LDQsdC70LjRhtGDINC40Lcg0LjRgdGF0L7QtNC90L7Qs9C+INC60L7QtNCwXG4gICAgICAgIGNvbnN0IGN1dEV4dGVybmFsQ29udGVudCA9IGV4dGVybmFsQ29udGVudC5zdWJzdHIoMzE5NiwgZXh0ZXJuYWxDb250ZW50Lmxlbmd0aCAtIDMzNzApO1xuICAgICAgICAvL2NvbnNvbGUubG9nKGN1dEV4dGVybmFsQ29udGVudCk7XG4gICAgICAgIGNvbnN0IGhpZGRlblRhYmxlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmhpZGRlbi10YWJsZScpO1xuICAgICAgICBoaWRkZW5UYWJsZS5pbm5lckhUTUwgPSBjdXRFeHRlcm5hbENvbnRlbnQ7XG4gICAgICAgIC8v0LLRi9GC0LDRgdC60LjQstCw0LXQvCDRgdGC0YDQvtC60LhcbiAgICAgICAgY29uc3Qgcm93cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0cicpO1xuICAgICAgICAvL9C/0LXRgNC10LzQtdC90L3QsNGPINC00LvRjyDRgdGC0YDQvtC6INGE0LjQu9GM0YLRgNC+0LLQsNC90L3QvtC5INGC0LDQsdC70LjRhtGLXG4gICAgICAgIGxldCBmaWx0ZXJlZFJvd3MgPSBbXTtcblxuICAgICAgICAvL9GD0LTQsNC70Y/QtdC8INGB0YLRgNC+0LrQuCDQt9Cw0LPQvtC70L7QstC60L7QsiDRgtCw0LHQu9C40YYsINGD0LTQsNC70Y/QtdC8INC+0YLQvNC10L3QtdC90L3Ri9C1INC30LDQutCw0LfRiywg0YTQvtGA0LzQuNGA0YPQtdC8INC+0LTQvdGDINGC0LDQsdC70LjRhtGDINC40Lcg0LTQstGD0YVcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAocm93c1tpXS5pbm5lckhUTUwubGVuZ3RoICE9PSAzNzcpIHtcbiAgICAgICAgICAgICAgICBpZiAocm93c1tpXS5jaGlsZHJlblszXS5pbm5lckhUTUwubGVuZ3RoID4gMTAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvd3NbaV0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChyb3dzW2ldKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJlZFJvd3MucHVzaChyb3dzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy/Rg9C00LDQu9GP0LXQvCDRh9C10YLQstC10YDRgtGD0Y4g0Y/Rh9C10LnQutGDXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsdGVyZWRSb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBmaWx0ZXJlZFJvd3NbaV0ucmVtb3ZlQ2hpbGQoZmlsdGVyZWRSb3dzW2ldLmNoaWxkcmVuWzNdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5ld0NvbnRlbnRPYmplY3QgPSBuZXcgbWFpbk9iamVjdENsYXNzKCk7XG4gICAgICAgIGZpbHRlcmVkUm93cy5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvcmRlck51bWJlciA9IHBhcnNlSW50KGl0ZW0uY2hpbGRyZW5bMF0uY2hpbGRyZW5bMF0uY2hpbGRyZW5bMF0uaW5uZXJIVE1MKTtcbiAgICAgICAgICAgIGNvbnN0IG9yZGVyID0gbmV3IG9yZGVyQ2xhc3Mob3JkZXJOdW1iZXIpO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhpdGVtLmNoaWxkcmVuWzFdLmNoaWxkcmVuWzBdLmlubmVySFRNTC5sZW5ndGgpO1xuICAgICAgICAgICAgaWYgKGl0ZW0uY2hpbGRyZW5bMV0uY2hpbGRyZW5bMF0uaW5uZXJIVE1MLmxlbmd0aCA+IDMwKSB7XG4gICAgICAgICAgICAgICAgb3JkZXIuc2V0UXVldWUoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS5jaGlsZHJlblsyXS5jaGlsZHJlblswXS5pbm5lckhUTUwubGVuZ3RoID4gMzApIHtcbiAgICAgICAgICAgICAgICBvcmRlci5zZXRQcmVwYXJpbmcoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ld0NvbnRlbnRPYmplY3Qub3JkZXJzLnB1c2gob3JkZXIpO1xuICAgICAgICB9KVxuXG4gICAgICAgIC8v0YPQtNCw0LvRj9C10Lwg0YLQsNCx0LvQuNGG0YNcbiAgICAgICAgaGlkZGVuVGFibGUuaW5uZXJIVE1MID0gJyc7XG5cbiAgICAgICAgaWYgKCFpc01haW5PYmplY3RFeGlzdHMoKSkge1xuICAgICAgICAgICAgc2V0TWFpbk9iamVjdChuZXdDb250ZW50T2JqZWN0KTtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q29udGVudChleHRlcm5hbENvbnRlbnQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3Qgbm90Rm9ybWF0dGVkbWFpbk9iamVjdCA9IGdldE1haW5PYmplY3QoKTtcbiAgICAgICAgICAgIGNvbnN0IG1haW5PYmplY3QgPSBuZXcgbWFpbk9iamVjdENsYXNzKCk7XG5cbiAgICAgICAgICAgIG1haW5PYmplY3QucmVxdWVzdEludGVydmFsID0gbm90Rm9ybWF0dGVkbWFpbk9iamVjdC5yZXF1ZXN0SW50ZXJ2YWw7XG4gICAgICAgICAgICBtYWluT2JqZWN0Lm1lc3NhZ2VUaW1lID0gbm90Rm9ybWF0dGVkbWFpbk9iamVjdC5tZXNzYWdlVGltZTtcbiAgICAgICAgICAgIG1haW5PYmplY3QuZXhwaXJhdGlvblRpbWUgPSBub3RGb3JtYXR0ZWRtYWluT2JqZWN0LmV4cGlyYXRpb25UaW1lO1xuXG4gICAgICAgICAgICBub3RGb3JtYXR0ZWRtYWluT2JqZWN0Lm9yZGVycy5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGN1cnJlbnRPcmRlciA9IG5ldyBvcmRlckNsYXNzKGl0ZW0ub3JkZXJOdW1iZXIpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRPcmRlci5leHBpcmVkID0gaXRlbS5leHBpcmVkO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRPcmRlci5tZXNzYWdlU2VudCA9IGl0ZW0ubWVzc2FnZVNlbnQ7XG4gICAgICAgICAgICAgICAgY3VycmVudE9yZGVyLmNvbXBsZXRlID0gaXRlbS5jb21wbGV0ZTtcbiAgICAgICAgICAgICAgICBjdXJyZW50T3JkZXIuY29tcGxldGVUaW1lID0gaXRlbS5jb21wbGV0ZVRpbWU7XG4gICAgICAgICAgICAgICAgY3VycmVudE9yZGVyLmluUXVldWUgPSBpdGVtLmluUXVldWU7XG4gICAgICAgICAgICAgICAgY3VycmVudE9yZGVyLnByZXBhcmluZyA9IGl0ZW0ucHJlcGFyaW5nO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRPcmRlci5yZW1hZGUgPSBpdGVtLnJlbWFkZTtcbiAgICAgICAgICAgICAgICBjdXJyZW50T3JkZXIudW5peFRpbWUgPSBpdGVtLnVuaXhUaW1lO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRPcmRlci5kYXRlID0gaXRlbS5kYXRlO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRPcmRlci5uZWVkTWVzc2FnZSA9IGl0ZW0ubmVlZE1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgbWFpbk9iamVjdC5vcmRlcnMucHVzaChjdXJyZW50T3JkZXIpO1xuICAgICAgICAgICAgfSlcblxuXG4gICAgICAgICAgICAvLyDQlNC+0LHQsNCy0LvRj9C10Lwg0L3QvtCy0YvQtSDQt9Cw0LrQsNC30YtcbiAgICAgICAgICAgIG5ld0NvbnRlbnRPYmplY3Qub3JkZXJzLmZvckVhY2goKGl0ZW0sIGkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzbWFpbk9iamVjdENvbnRhaW5zT3JkZXIobWFpbk9iamVjdCwgaXRlbS5vcmRlck51bWJlcikpIHtcbiAgICAgICAgICAgICAgICAgICAgbWFpbk9iamVjdC5vcmRlcnMucHVzaChuZXdDb250ZW50T2JqZWN0Lm9yZGVyc1tpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC8v0LXRgdC70Lgg0YHRgtCw0YDQvtCz0L4g0LfQsNC60LDQt9CwINC90LXRgiDQsiDRgdC/0LjRgdC60LUg0LfQsNC60LDQt9C+0LIg0L3QvtCy0L7Qs9C+INC+0LHRitC10LrRgtCwLCDQv9C+0LzQtdGH0LDQtdC8INGB0YLQsNGA0YvQuSDQv9C+0LTRgtCy0LXRgNC20LTQtdC90L3Ri9C8XG4gICAgICAgICAgICBtYWluT2JqZWN0Lm9yZGVycy5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFnZXRTYW1lT3JkZXIobmV3Q29udGVudE9iamVjdCwgaXRlbS5vcmRlck51bWJlcikpIHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXRDb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAvL9C/0L7Qu9GD0YfQsNC10Lwg0L/QtdGA0LXQstGL0LPRgNGD0LbQtdC90L3Ri9C1INC30LDQutCw0LfRi1xuICAgICAgICAgICAgbmV3Q29udGVudE9iamVjdC5vcmRlcnMuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChpc09yZGVyUmVtYWRlKG1haW5PYmplY3QsIGl0ZW0ub3JkZXJOdW1iZXIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWFpbk9iamVjdC5vcmRlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWluT2JqZWN0Lm9yZGVyc1tpXS5vcmRlck51bWJlciA9PT0gaXRlbS5vcmRlck51bWJlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5PYmplY3Qub3JkZXJzW2ldLnJlbWFkZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbk9iamVjdC5vcmRlcnNbaV0uZXhwaXJlZCA9IGl0ZW0uZXhwaXJlZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluT2JqZWN0Lm9yZGVyc1tpXS5tZXNzYWdlU2VudCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5PYmplY3Qub3JkZXJzW2ldLnVuaXhUaW1lID0gcGFyc2VJbnQobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluT2JqZWN0Lm9yZGVyc1tpXS5jb21wbGV0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5PYmplY3Qub3JkZXJzW2ldLmNvbXBsZXRlVGltZSA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbk9iamVjdC5vcmRlcnNbaV0uaW5RdWV1ZSA9IGl0ZW0uaW5RdWV1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluT2JqZWN0Lm9yZGVyc1tpXS5wcmVwYXJpbmcgPSBpdGVtLnByZXBhcmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluT2JqZWN0Lm9yZGVyc1tpXS5kYXRlID0gaXRlbS5kYXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5PYmplY3Qub3JkZXJzW2ldLm5lZWRNZXNzYWdlID0gaXRlbS5uZWVkTWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIC8v0LfQsNC00LDQtdC8INCy0YDQtdC80Y8g0L3QsNCx0L7RgNC60LhcbiAgICAgICAgICAgIG1haW5PYmplY3Qub3JkZXJzLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5jb21wbGV0ZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXRUaW1lKHBhcnNlSW50KG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIC8v0L/RgNC+0LLQtdGA0Y/QtdC8INC90LAg0L/RgNC+0YHRgNC+0YfQutGDXG5cbiAgICAgICAgICAgIG1haW5PYmplY3Qub3JkZXJzLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5jb21wbGV0ZVRpbWUgPiBtYWluT2JqZWN0LmV4cGlyYXRpb25UaW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uc2V0RXhwaXJlZCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIC8v0YPQtNCw0LvRj9C10Lwg0LfQsNC60LDQt9GLINCy0L7Qt9GA0LDRgdGC0L7QvCDQsdC+0LvQtdC1IDEwINC00L3QtdC5XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gbWFpbk9iamVjdC5vcmRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgICAgICBpZiAocGFyc2VJbnQobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKSAtIG1haW5PYmplY3Qub3JkZXJzW2ldLnVuaXhUaW1lID4gODY0MDAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1haW5PYmplY3Qub3JkZXJzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNldE1haW5PYmplY3QobWFpbk9iamVjdCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgc2V0V2FybmluZygpIHtcbiAgICAgICAgY29uc3QgbWFpbk9iamVjdCA9IGdldE1haW5PYmplY3QoKTtcbiAgICAgICAgbWFpbk9iamVjdC5vcmRlcnMuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgaWYgKHBhcnNlSW50KG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkgLSBpdGVtLnVuaXhUaW1lID4gbWFpbk9iamVjdC5tZXNzYWdlVGltZSAmJiAhaXRlbS5jb21wbGV0ZSAmJiAhaXRlbS5tZXNzYWdlU2VudCkge1xuICAgICAgICAgICAgICAgIGl0ZW0ubmVlZE1lc3NhZ2UgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICBzZXRNYWluT2JqZWN0KG1haW5PYmplY3QpO1xuICAgIH1cblxuXG59IiwiY29uc3QgdmlldyA9IHtcbiAgICBkcmF3VGFibGUoKSB7XG4gICAgICAgIGNvbnN0IG1haW5PYmplY3QgPSBnZXRNYWluT2JqZWN0KCk7XG4gICAgICAgIGNvbnN0IG5ld1RhYmxlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm5ldy10YWJsZScpO1xuICAgICAgICBuZXdUYWJsZS5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWVuZCcsICcnICtcbiAgICAgICAgICAgICcgICAgICAgICAgICAgICAgIDx0aGVhZD4nICtcbiAgICAgICAgICAgICcgICAgICAgICAgICAgICAgICAgIDx0ciBjbGFzcz1cIm5ldy10YWJsZV9faGVhZGVyXCI+XFxuJyArXG4gICAgICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgICAgPHRoIGNsYXNzPVwibmV3LXRhYmxlX19oZWFkZXItY2VsbFwiPuKEljwvdGg+XFxuJyArXG4gICAgICAgICAgICAnICAgICAgICAgICAgICAgICAgICAgICAgPHRoIGNsYXNzPVwibmV3LXRhYmxlX19oZWFkZXItY2VsbFwiPtCd0L7QvNC10YAg0LfQsNC60LDQt9CwPC90aD5cXG4nICtcbiAgICAgICAgICAgICcgICAgICAgICAgICAgICAgICAgICAgICA8dGggY2xhc3M9XCJuZXctdGFibGVfX2hlYWRlci1jZWxsXCI+0JIg0L7Rh9C10YDQtdC00Lg8L3RoPlxcbicgK1xuICAgICAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgICAgIDx0aCBjbGFzcz1cIm5ldy10YWJsZV9faGVhZGVyLWNlbGxcIj7QkiDQvdCw0LHQvtGA0LU8L3RoPlxcbicgK1xuICAgICAgICAgICAgJyAgICAgICAgICAgICAgICAgICAgICAgIDx0aCBjbGFzcz1cIm5ldy10YWJsZV9faGVhZGVyLWNlbGxcIj7Ql9Cw0LLQtdGA0YjQtdC9PC90aD5cXG4nICtcbiAgICAgICAgICAgICcgICAgICAgICAgICAgICAgICAgICAgICA8dGggY2xhc3M9XCJuZXctdGFibGVfX2hlYWRlci1jZWxsXCI+0JLRgNC10LzRjzwvdGg+XFxuJyArXG4gICAgICAgICAgICAnICAgICAgICAgICAgICAgICAgICA8L3RyPicgK1xuICAgICAgICAgICAgJyAgICAgICAgICAgICAgICAgPC90aGVhZD4nKTtcblxuICAgICAgICBsZXQgY291bnRlciA9IDE7XG4gICAgICAgIG1haW5PYmplY3Qub3JkZXJzLmZvckVhY2goKGl0ZW0pID0+IHtcblxuICAgICAgICAgICAgbGV0IGluUXVldWUgPSAnJztcbiAgICAgICAgICAgIGlmIChpdGVtLmluUXVldWUgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBpblF1ZXVlID0gJ1gnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IHByZXBhcmluZyA9ICcnO1xuICAgICAgICAgICAgaWYgKGl0ZW0ucHJlcGFyaW5nID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgcHJlcGFyaW5nID0gJ1gnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGNvbXBsZXRlID0gJyc7XG4gICAgICAgICAgICBpZiAoaXRlbS5jb21wbGV0ZSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIGNvbXBsZXRlID0gJ1gnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IHRpbWUgPSBzZWNvbmRzVGltZVRvTm9ybWFsKGl0ZW0uY29tcGxldGVUaW1lKTtcbiAgICAgICAgICAgIGlmIChpdGVtLmRhdGUgPT09IHBhcnNlSW50KG5ldyBEYXRlKCkuZ2V0RGF0ZSgpKSAmJiBpdGVtLnJlbWFkZSAmJiAhaXRlbS5tZXNzYWdlU2VudCkge1xuICAgICAgICAgICAgICAgIG5ld1RhYmxlLmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywgYFxuICAgICAgICAgICAgICAgICAgICA8dGJvZHk+XG4gICAgICAgICAgICAgICAgICAgICAgICA8dHIgY2xhc3M9XCJuZXctdGFibGVfX3JvdyBuZXctdGFibGVfX29yZGVyLXJlbWFkZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz1cIm5ldy10YWJsZV9fY2VsbFwiPiR7Y291bnRlcn08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz1cIm5ldy10YWJsZV9fY2VsbFwiPiR7aXRlbS5vcmRlck51bWJlcn08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz1cIm5ldy10YWJsZV9fY2VsbFwiPiR7aW5RdWV1ZX08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz1cIm5ldy10YWJsZV9fY2VsbFwiPiR7cHJlcGFyaW5nfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtjb21wbGV0ZX08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz1cIm5ldy10YWJsZV9fY2VsbFwiPiR7dGltZX08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgPC90Ym9keT5gXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtLmRhdGUgPT09IHBhcnNlSW50KG5ldyBEYXRlKCkuZ2V0RGF0ZSgpKSAmJiAhaXRlbS5leHBpcmVkICYmICFpdGVtLm1lc3NhZ2VTZW50KSB7XG4gICAgICAgICAgICAgICAgbmV3VGFibGUuaW5zZXJ0QWRqYWNlbnRIVE1MKCdiZWZvcmVlbmQnLCBgXG4gICAgICAgICAgICAgICAgICAgIDx0Ym9keT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0ciBjbGFzcz1cIm5ldy10YWJsZV9fcm93IG5ldy10YWJsZV9fb3JkZXItbm9ybWFsXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtjb3VudGVyfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtpdGVtLm9yZGVyTnVtYmVyfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtpblF1ZXVlfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtwcmVwYXJpbmd9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJuZXctdGFibGVfX2NlbGxcIj4ke2NvbXBsZXRlfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHt0aW1lfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICA8L3Rib2R5PmBcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0uZGF0ZSA9PT0gcGFyc2VJbnQobmV3IERhdGUoKS5nZXREYXRlKCkpICYmICFpdGVtLmV4cGlyZWQgJiYgaXRlbS5tZXNzYWdlU2VudCkge1xuICAgICAgICAgICAgICAgIG5ld1RhYmxlLmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlZW5kJywgYFxuICAgICAgICAgICAgICAgICAgICA8dGJvZHk+XG4gICAgICAgICAgICAgICAgICAgICAgICA8dHIgY2xhc3M9XCJuZXctdGFibGVfX3JvdyBuZXctdGFibGVfX29yZGVyLXdhcm5pbmdcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJuZXctdGFibGVfX2NlbGxcIj4ke2NvdW50ZXJ9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJuZXctdGFibGVfX2NlbGxcIj4ke2l0ZW0ub3JkZXJOdW1iZXJ9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJuZXctdGFibGVfX2NlbGxcIj4ke2luUXVldWV9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJuZXctdGFibGVfX2NlbGxcIj4ke3ByZXBhcmluZ308L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZCBjbGFzcz1cIm5ldy10YWJsZV9fY2VsbFwiPiR7Y29tcGxldGV9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJuZXctdGFibGVfX2NlbGxcIj4ke3RpbWV9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgICAgICAgICAgIDwvdGJvZHk+YFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS5kYXRlID09PSBwYXJzZUludChuZXcgRGF0ZSgpLmdldERhdGUoKSkgJiYgaXRlbS5leHBpcmVkICYmIGl0ZW0ubWVzc2FnZVNlbnQpIHtcbiAgICAgICAgICAgICAgICBuZXdUYWJsZS5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWVuZCcsIGBcbiAgICAgICAgICAgICAgICAgICAgPHRib2R5PlxuICAgICAgICAgICAgICAgICAgICAgICAgPHRyIGNsYXNzPVwibmV3LXRhYmxlX19yb3cgbmV3LXRhYmxlX19vcmRlci1leHBpcmVkXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtjb3VudGVyfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtpdGVtLm9yZGVyTnVtYmVyfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtpblF1ZXVlfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHtwcmVwYXJpbmd9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJuZXctdGFibGVfX2NlbGxcIj4ke2NvbXBsZXRlfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIGNsYXNzPVwibmV3LXRhYmxlX19jZWxsXCI+JHt0aW1lfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICA8L3Rib2R5PmBcbiAgICAgICAgICAgICAgICApXG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvdW50ZXIrKztcbiAgICAgICAgfSlcblxuICAgIH0sXG5cbiAgICBzZW5kTWVzc2FnZShtZXNzYWdlKSB7XG4gICAgICAgIGNvbnN0IHggPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgeC5vcGVuKCdHRVQnLCAnaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdDEwMTg3NTcwMTM6QUFFSE85YWNjVWhzY2llVDBBclJxOWl3VWVhdDZCbUV6T00vc2VuZE1lc3NhZ2U/Y2hhdF9pZD0tMTAwMTQ3MTY3NzYxNCZ0ZXh0PScgKyBtZXNzYWdlKTtcbiAgICAgICAgeC5zZW5kKCk7XG5cblxuICAgIH0sXG5cbiAgICBzZW5kTWVzc2FnZXMoKSB7XG4gICAgICAgIGNvbnN0IG1haW5PYmplY3QgPSBnZXRNYWluT2JqZWN0KCk7XG4gICAgICAgIG1haW5PYmplY3Qub3JkZXJzLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgICAgIGlmIChpdGVtLm5lZWRNZXNzYWdlID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kTWVzc2FnZSgn0JfQsNC60LDQtyAnICsgaXRlbS5vcmRlck51bWJlciArICcg0LIg0L3QsNCx0L7RgNC1INGD0LbQtSDQsdC+0LvQtdC1ICcgKyBtYWluT2JqZWN0Lm1lc3NhZ2VUaW1lIC8gNjAgKyAnINC80LjQvdGD0YInKTtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCfQl9Cw0LrQsNC3ICcgKyBpdGVtLm9yZGVyTnVtYmVyICsgJyDQsiDQvdCw0LHQvtGA0LUg0YPQttC1INCx0L7Qu9C10LUgJyArIG1haW5PYmplY3QuZXhwaXJhdGlvblRpbWUgLyA2MCArICcg0LzQuNC90YPRgicpXG4gICAgICAgICAgICAgICAgaXRlbS5tZXNzYWdlU2VudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgaXRlbS5uZWVkTWVzc2FnZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICBzZXRNYWluT2JqZWN0KG1haW5PYmplY3QpO1xuICAgIH0sXG5cbiAgICBzZXRQbGFjZWhvbGRlcnMoKSB7XG4gICAgICAgIGNvbnN0IG1haW5PYmplY3QgPSBnZXRNYWluT2JqZWN0KCk7XG4gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vcHRpb25zX190aW1lLXRvLWV4cGlyZScpLnBsYWNlaG9sZGVyID0gbWFpbk9iamVjdC5leHBpcmF0aW9uVGltZSAvIDYwO1xuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcub3B0aW9uc19fdGltZS10by1zZW5kLW1lc3NhZ2UnKS5wbGFjZWhvbGRlciA9IG1haW5PYmplY3QubWVzc2FnZVRpbWUgLyA2MDtcbiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm9wdGlvbnNfX3JlcXVlc3QtaW50ZXJ2YWwnKS5wbGFjZWhvbGRlciA9IG1haW5PYmplY3QucmVxdWVzdEludGVydmFsO1xuICAgIH1cbn0iLCJjb25zdCBjb250cm9sbGVyID0ge1xuICAgIG1haW5Sb3V0ZSgpe1xuICAgICAgICBsZXQgaW50ZXJ2YWwgPSAxMDtcbiAgICAgICAgaWYgKGlzTWFpbk9iamVjdEV4aXN0cygpKSB7XG4gICAgICAgICAgICBjb25zdCBtYWluT2JqZWN0ID0gZ2V0TWFpbk9iamVjdCgpO1xuICAgICAgICAgICAgaW50ZXJ2YWwgPSBtYWluT2JqZWN0LnJlcXVlc3RJbnRlcnZhbDtcbiAgICAgICAgfVxuXG4gICAgICAgIG1vZGVsLmNhbGxFeHRlcm5hbENvbnRlbnQoKVxuICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgbW9kZWwuZ2V0Q29udGVudChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgbW9kZWwuc2V0V2FybmluZygpO1xuICAgICAgICAgICAgICAgIHZpZXcuc2VuZE1lc3NhZ2VzKCk7XG4gICAgICAgICAgICAgICAgdmlldy5kcmF3VGFibGUoKTtcbiAgICAgICAgICAgICAgICB2aWV3LnNldFBsYWNlaG9sZGVycygpO1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbnRlcnZhbCcpLnNjcm9sbEludG9WaWV3KCk7XG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgICAgICAgfSwgaW50ZXJ2YWwgKiAxMDAwKTtcbiAgICB9XG59IiwiZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgKCkgPT4ge1xuY29udHJvbGxlci5tYWluUm91dGUoKTtcbn0pXG4iLCIvL9GD0YHRgtCw0L3QsNCy0LvQuNCy0LDQtdC8INC40L3RgtC10YDQstCw0LssINCy0YDQtdC80Y8g0YHQvtC+0LHRidC10L3QuNGPLCDQstGA0LXQvNGPINC00L4g0L/RgNC+0YHRgNC+0YfQutC4XG5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcub3B0aW9uc19fdGltZS10by1leHBpcmUtYnV0dG9uJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBjb25zdCBleHBpcmVUZXh0QXJlYSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vcHRpb25zX190aW1lLXRvLWV4cGlyZScpO1xuICAgIGlmIChleHBpcmVUZXh0QXJlYS52YWx1ZSkge1xuICAgICAgICBjb25zdCBtYWluT2JqZWN0ID0gZ2V0TWFpbk9iamVjdCgpO1xuICAgICAgICBtYWluT2JqZWN0LmV4cGlyYXRpb25UaW1lID0gcGFyc2VJbnQoZXhwaXJlVGV4dEFyZWEudmFsdWUpICogNjA7XG4gICAgICAgIHNldE1haW5PYmplY3QobWFpbk9iamVjdCk7XG4gICAgICAgIGV4cGlyZVRleHRBcmVhLnBsYWNlaG9sZGVyID0gZXhwaXJlVGV4dEFyZWEudmFsdWU7XG4gICAgICAgIGV4cGlyZVRleHRBcmVhLnZhbHVlID0gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZUJveCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vcHRpb25zX19tZXNzYWdlLWJveC10aW1lLXRvLWV4cGlyZScpO1xuICAgICAgICBtZXNzYWdlQm94LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIG1lc3NhZ2VCb3guc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgfSwgMTAwMClcbiAgICB9XG59KVxuXG5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcub3B0aW9uc19fdGltZS10by1zZW5kLW1lc3NhZ2UtYnV0dG9uJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBjb25zdCBtZXNzYWdlVGV4dEFyZWEgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcub3B0aW9uc19fdGltZS10by1zZW5kLW1lc3NhZ2UnKTtcbiAgICBpZiAobWVzc2FnZVRleHRBcmVhLnZhbHVlKSB7XG4gICAgICAgIGNvbnN0IG1haW5PYmplY3QgPSBnZXRNYWluT2JqZWN0KCk7XG4gICAgICAgIG1haW5PYmplY3QubWVzc2FnZVRpbWUgPSBwYXJzZUludChtZXNzYWdlVGV4dEFyZWEudmFsdWUpICogNjA7XG4gICAgICAgIG1lc3NhZ2VUZXh0QXJlYS5wbGFjZWhvbGRlciA9IG1lc3NhZ2VUZXh0QXJlYS52YWx1ZTtcbiAgICAgICAgbWVzc2FnZVRleHRBcmVhLnZhbHVlID0gJyc7XG4gICAgICAgIHNldE1haW5PYmplY3QobWFpbk9iamVjdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZUJveCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vcHRpb25zX19tZXNzYWdlLWJveC10aW1lLXRvLXNlbmQtbWVzc2FnZScpO1xuICAgICAgICBtZXNzYWdlQm94LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIG1lc3NhZ2VCb3guc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgfSwgMTAwMClcbiAgICB9XG59KVxuXG5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcub3B0aW9uc19fcmVxdWVzdC1pbnRlcnZhbC1idXR0b24nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGNvbnN0IHJlcXVlc3RUZXh0QXJlYSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vcHRpb25zX19yZXF1ZXN0LWludGVydmFsJyk7XG4gICAgaWYgKHJlcXVlc3RUZXh0QXJlYS52YWx1ZSAmJiBwYXJzZUludChyZXF1ZXN0VGV4dEFyZWEudmFsdWUpID49IDEwKSB7XG4gICAgICAgIGNvbnN0IG1haW5PYmplY3QgPSBnZXRNYWluT2JqZWN0KCk7XG4gICAgICAgIG1haW5PYmplY3QucmVxdWVzdEludGVydmFsID0gcGFyc2VJbnQocmVxdWVzdFRleHRBcmVhLnZhbHVlKTtcbiAgICAgICAgcmVxdWVzdFRleHRBcmVhLnBsYWNlaG9sZGVyID0gcmVxdWVzdFRleHRBcmVhLnZhbHVlO1xuICAgICAgICByZXF1ZXN0VGV4dEFyZWEudmFsdWUgPSAnJztcbiAgICAgICAgc2V0TWFpbk9iamVjdChtYWluT2JqZWN0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBtZXNzYWdlQm94ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm9wdGlvbnNfX21lc3NhZ2UtYm94LXJlcXVlc3QtaW50ZXJ2YWwnKTtcbiAgICAgICAgbWVzc2FnZUJveC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgcmVxdWVzdFRleHRBcmVhLnZhbHVlID0gJyc7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgbWVzc2FnZUJveC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICB9LCAxMDAwKVxuICAgIH1cbn0pXG5cbmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5yZXNldCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57XG4gICAgY29uc3QgbXNnID0gcHJvbXB0KCfQlNC10LnRgdGC0LLQuNGC0LXQu9GM0L3Qvj8g0JLRgdC1INC00LDQvdC90YvQtSDRg9C00LDQu9GP0YLRgdGPISDQlNC70Y8g0L/RgNC+0LTQvtC70LbQtdC90LjRjyDQstCy0LXQtNC40YLQtSBcItCj0JTQkNCb0JjQotCsIVwiINCx0L7Qu9GM0YjQuNC80Lgg0LHRg9C60LLQsNC80LgnKTtcbiAgICBpZihtc2cgPT09J9Cj0JTQkNCb0JjQotCsIScpe1xuICAgICAgICBsb2NhbFN0b3JhZ2UuY2xlYXIoKTtcbiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgIH1cbn0pIl19
